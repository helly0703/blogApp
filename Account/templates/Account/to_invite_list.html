{% extends 'Account/home_base.html' %}
{% load static %}
{%block title%}
Add Friends
{% endblock title%}
{% block content %}
{% load crispy_forms_tags %}
    {% if user.is_authenticated %}
<!--        <a href="javascript:history.go(-1)" class="btn btn-outline-secondary">Back</a>-->
        <div class="container">
            <br>
            <form action="{% url 'search_profile' %}" name="search-profile" id="search-profile" method="get">
                {% csrf_token%}
                <span class="fa fa-search form-control-feedback">
                    <input type="text" id="search_field" name="search_field" >
                </span>
            </form>
            <br>
            {% for object in qs %}
            {% if not user in object.user.account.blockedlist.all %}
                <div class="row" style="padding-bottom:2px">
                  <div class="col-md-2 col-sm-2">
                    <img src="{{ object.image.url }}" alt="user" height="50px"
                         width="50px" style="border-radius:50%">
                  </div>
                  <div class="col-md-7 col-sm-7">
                    <h5><a href="{% url 'friend_detail' object.id %}" class="profile-link">{{ object }}</a></h5>
                  </div>
                  <div class="col-md-3 col-sm-3">
<!--                    <button class="btn btn-primary pull-right">Add Friend</button>-->

                       <form action="{% url 'send_invite' %}" method="post" >
                        {% csrf_token%}
                          <input type="hidden" name="profile_pk" value="{{ object.id }}" >
                        {% if object.user not in user.account.blockedlist.all%}
                           {%if object in user.account.check_received_request%}

                        <form action="{% url 'accept_request' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="profile_pk" value="{{ object.id}}">
                            <button type="submit" class="btn btn-primary pull-right">Accept Friend Request</button>
                        </form>

                        <form action="{% url 'remove_request' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="profile_pk" value="{{ object.id }}">
                            <button type="submit" class="btn btn-primary pull-right">Remove from Friend Request</button>
                        </form>

                    {% elif object in user.account.check_send_request %}
                        <button class="btn btn-primary pull-right" disabled>Waiting for response</button>

                    {% elif object.get_user not in user.account.friendslist.all %}
                        <form id="add-friend">
                            {% csrf_token%}
                            <input type="hidden" name="profile_pk" class="user_id" id="user_id" value="{{ object.id }}">
                            <button type="button"  id="add-frnd" class="btn btn-primary pull-right"
                                    value="{{ object.id }}">Add friend</button>
                        </form>

                    {% else%}

                    <form id="remove-friend">
                        {% csrf_token%}
                        <input type="hidden" name="profile_pk" value="{{ object.id }}">
                        <button type="button" id="remove-frnd" value="{{ object.id }}"
                                class="btn btn-primary pull-right">Remove from friends</button>
                    </form>

                    {% endif %}

                        {% else%}
                          <button  type="button"  id="add-frnds" class="btn btn-primary"
                                   value="{{ object.id }}">Unblock and Add friend</button>
                        {% endif %}
                      </form>

                  </div>
                </div>
            {% endif %}
            <br>
            {% endfor %}
        </div>
    {% else %}
        <small class="text-muted"><a href="{% url 'login' %}" class="ml-2">Login</a></small>
    {% endif %}

{% endblock content %}



{% block scripts%}
<script>
$(document).ready(function(){
window.onload = function() {
	if(!window.location.hash) {
		window.location = window.location;
		window.location.reload();
	}
};
console.log('Hey');

$.ajaxSetup({
       headers: {
         "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
       }
   });
$("#add-frnd").click(function() {
    var user = $(this).val()
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "{% url 'send_invite' %}",
      data: {
        'profile_pk': user,
        },
      success:  function () {
        console.log('Success');
        location.reload();
       },
    });
    return false;
  });
  $("#add-frnds").click(function() {
    var user = $(this).val()
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "{% url 'send_invite' %}",
      data: {
        'profile_pk': user,
        },
      success:  function () {
        console.log('Success');
        location.reload();
       },
    });
    return false;
  });
  $("#remove-frnd").click(function() {
    console.log('Start');
    var user = $(this).val();
    console.log(user);
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "{%url 'remove_friend' %}",
      data: {
        'profile_pk': user,
        },
      success:  function () {
        console.log('Success');
        location.reload();
       },
    });
    return false;
  });
});
</script>>
{% endblock scripts%}

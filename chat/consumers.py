import json
from channels.consumer import AsyncConsumer
from channels.db import database_sync_to_async
from django.contrib.auth.models import User

from chat.models import Thread, ChatMessage
import base64
from django.core.files.base import ContentFile
#
# def base64_file(data, name=None):
#     _format, _img_str = data.split(';base64,')
#     _name, ext = _format.split('/')
#     if not name:
#         name = _name.split(":")[-1]
#     return ContentFile(base64.b64decode(_img_str), name='{}.{}'.format(name, ext))


class ChatConsumer(AsyncConsumer):

    async def websocket_connect(self, event):
        print('connected', event)
        user = self.scope['user']
        chat_room = f'user_chatroom_{user.id}'
        self.chat_room = chat_room
        await self.channel_layer.group_add(
            chat_room,
            self.channel_name
        )
        await self.send({
            'type': 'websocket.accept'
        })

    async def websocket_receive(self, event):
        print('receive', event)
        received_data = json.loads(event['text'])
        # file_ = received_data.get('file')
        # print(file_)
        # file_object = json.loads(received_data.get('file_obj'))
        # print(file_object)
        test_file_1 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADMAAAAzCAIAAAC1w6d9AAAAh3pUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjadY7LDcQwCETvVJESMOAByllFiZQOtvzFcqzksu8AoxGfoeN7nbQNGgtZ90ACXFhayqdE8ESZm3Abverk7tpKyWOTyhTIcLZn0G5/0RWB080dHTt2qetyqGhUrT0aV3nEyNc3XYn++CvFD0K+LCGFVYifAAAKAmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgZXhpZjpQaXhlbFhEaW1lbnNpb249IjUxIgogICBleGlmOlBpeGVsWURpbWVuc2lvbj0iNTEiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iNTEiCiAgIHRpZmY6SW1hZ2VIZWlnaHQ9IjUxIgogICB0aWZmOk9yaWVudGF0aW9uPSIxIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz5pZgYrAAAAA3NCSVQICAjb4U/gAAAAR0lEQVRYw+3OsREAEBAAQfT+ORHdviJeINgr4GZ7ZranxVmxZ/0z2q+RkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkVW7puAGvSEr+egAAAAASUVORK5CYII="
        # test_file_1 = "data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgaHR0cC1lcXVpdj0iY29udGVudC10eXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiPgogIDx0aXRsZT5QYWdlIG5vdCBmb3VuZCBhdCAvY2hhdC9bb2JqZWN0IE9iamVjdF08L3RpdGxlPgogIDxtZXRhIG5hbWU9InJvYm90cyIgY29udGVudD0iTk9ORSxOT0FSQ0hJVkUiPgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICBodG1sICogeyBwYWRkaW5nOjA7IG1hcmdpbjowOyB9CiAgICBib2R5ICogeyBwYWRkaW5nOjEwcHggMjBweDsgfQogICAgYm9keSAqICogeyBwYWRkaW5nOjA7IH0KICAgIGJvZHkgeyBmb250OnNtYWxsIHNhbnMtc2VyaWY7IGJhY2tncm91bmQ6I2VlZTsgY29sb3I6IzAwMDsgfQogICAgYm9keT5kaXYgeyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjZGRkOyB9CiAgICBoMSB7IGZvbnQtd2VpZ2h0Om5vcm1hbDsgbWFyZ2luLWJvdHRvbTouNGVtOyB9CiAgICBoMSBzcGFuIHsgZm9udC1zaXplOjYwJTsgY29sb3I6IzY2NjsgZm9udC13ZWlnaHQ6bm9ybWFsOyB9CiAgICB0YWJsZSB7IGJvcmRlcjpub25lOyBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB3aWR0aDoxMDAlOyB9CiAgICB0ZCwgdGggeyB2ZXJ0aWNhbC1hbGlnbjp0b3A7IHBhZGRpbmc6MnB4IDNweDsgfQogICAgdGggeyB3aWR0aDoxMmVtOyB0ZXh0LWFsaWduOnJpZ2h0OyBjb2xvcjojNjY2OyBwYWRkaW5nLXJpZ2h0Oi41ZW07IH0KICAgICNpbmZvIHsgYmFja2dyb3VuZDojZjZmNmY2OyB9CiAgICAjaW5mbyBvbCB7IG1hcmdpbjogMC41ZW0gNGVtOyB9CiAgICAjaW5mbyBvbCBsaSB7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IH0KICAgICNzdW1tYXJ5IHsgYmFja2dyb3VuZDogI2ZmYzsgfQogICAgI2V4cGxhbmF0aW9uIHsgYmFja2dyb3VuZDojZWVlOyBib3JkZXItYm90dG9tOiAwcHggbm9uZTsgfQogICAgcHJlLmV4Y2VwdGlvbl92YWx1ZSB7IGZvbnQtZmFtaWx5OiBzYW5zLXNlcmlmOyBjb2xvcjogIzU3NTc1NzsgZm9udC1zaXplOiAxLjVlbTsgbWFyZ2luOiAxMHB4IDAgMTBweCAwOyB9CiAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8ZGl2IGlkPSJzdW1tYXJ5Ij4KICAgIDxoMT5QYWdlIG5vdCBmb3VuZCA8c3Bhbj4oNDA0KTwvc3Bhbj48L2gxPgogICAgCiAgICA8dGFibGUgY2xhc3M9Im1ldGEiPgogICAgICA8dHI+CiAgICAgICAgPHRoPlJlcXVlc3QgTWV0aG9kOjwvdGg+CiAgICAgICAgPHRkPkdFVDwvdGQ+CiAgICAgIDwvdHI+CiAgICAgIDx0cj4KICAgICAgICA8dGg+UmVxdWVzdCBVUkw6PC90aD4KICAgICAgICA8dGQ+aHR0cDovLzEyNy4wLjAuMTo4MDAwL2NoYXQvJTVCb2JqZWN0JTIwT2JqZWN0JTVEPC90ZD4KICAgICAgPC90cj4KICAgICAgCiAgICA8L3RhYmxlPgogIDwvZGl2PgogIDxkaXYgaWQ9ImluZm8iPgogICAgCiAgICAgIDxwPgogICAgICBVc2luZyB0aGUgVVJMY29uZiBkZWZpbmVkIGluIDxjb2RlPkJsb2dBcHAudXJsczwvY29kZT4sCiAgICAgIERqYW5nbyB0cmllZCB0aGVzZSBVUkwgcGF0dGVybnMsIGluIHRoaXMgb3JkZXI6CiAgICAgIDwvcD4KICAgICAgPG9sPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFkbWluLwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgW25hbWU9J3JlZ2lzdGVyJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS8KICAgICAgICAgICAgICAgIFtuYW1lPSdob21lJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J3ZpZXdfcHJvZmlsZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvdXBkYXRlLXByb2ZpbGUvCiAgICAgICAgICAgICAgICBbbmFtZT0ncHJvZmlsZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvcHJvZmlsZS9zZXR0aW5ncy8KICAgICAgICAgICAgICAgIFtuYW1lPSdzZXR0aW5ncyddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvZnJpZW5kcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdmcmllbmRzX3BhZ2UnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2ZyaWVuZHMvYmxvY2tlZAogICAgICAgICAgICAgICAgW25hbWU9J2Jsb2NrX3VzZXJfcGFnZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvZnJpZW5kcy8mbHQ7aW50OnBrJmd0Oy8KICAgICAgICAgICAgICAgIFtuYW1lPSdmcmllbmRfZGV0YWlsJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9teS1pbnZpdGVzLwogICAgICAgICAgICAgICAgW25hbWU9J215X2ludml0ZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2FsbC1wcm9maWxlcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdhbGxfcHJvZmlsZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL3NlYXJjaC1wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J3NlYXJjaF9wcm9maWxlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9ibG9jay1wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J2Jsb2NrX3Byb2ZpbGUnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2ludml0ZS1wcm9maWxlcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdpbnZpdGVfcHJvZmlsZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL3NlbmQtaW52aXRlLwogICAgICAgICAgICAgICAgW25hbWU9J3NlbmRfaW52aXRlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9yZW1vdmUtZnJpZW5kLwogICAgICAgICAgICAgICAgW25hbWU9J3JlbW92ZV9mcmllbmQnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL215LWJsb2dzLwogICAgICAgICAgICAgICAgW25hbWU9J215X2Jsb2dzJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9hY2NlcHQtcmVxdWVzdC8KICAgICAgICAgICAgICAgIFtuYW1lPSdhY2NlcHRfcmVxdWVzdCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvcmVtb3ZlLXJlcXVlc3QvCiAgICAgICAgICAgICAgICBbbmFtZT0ncmVtb3ZlX3JlcXVlc3QnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL25vdGlmaWNhdGlvbnMvCiAgICAgICAgICAgICAgICBbbmFtZT0nbm90aWZpY2F0aW9ucyddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFjY291bnRzL2xvZ2luLwogICAgICAgICAgICAgICAgW25hbWU9J2xvZ2luJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nb3V0LwogICAgICAgICAgICAgICAgW25hbWU9J2xvZ291dCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIHBhc3N3b3JkLXJlc2V0LwogICAgICAgICAgICAgICAgW25hbWU9J3Bhc3N3b3JkX3Jlc2V0J10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcGFzc3dvcmQtcmVzZXQvZG9uZS8KICAgICAgICAgICAgICAgIFtuYW1lPSdwYXNzd29yZF9yZXNldF9kb25lJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcGFzc3dvcmQtcmVzZXQtY29uZmlybS8mbHQ7dWlkYjY0Jmd0Oy8mbHQ7dG9rZW4mZ3Q7CiAgICAgICAgICAgICAgICBbbmFtZT0ncGFzc3dvcmRfcmVzZXRfY29uZmlybSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIHBhc3N3b3JkLXJlc2V0LWNvbXBsZXRlLwogICAgICAgICAgICAgICAgW25hbWU9J3Bhc3N3b3JkX3Jlc2V0X2NvbXBsZXRlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2hhbmdlLXBhc3N3b3JkLwogICAgICAgICAgICAgICAgW25hbWU9J2NoYW5nZV9wYXNzd29yZCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvYmxvZ3MvCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNoYXQvCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFtuYW1lPSdzdGFydC1jaGF0J10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF5tZWRpYS8oP1AmbHQ7cGF0aCZndDsuKikkCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF5zdGF0aWMvKD9QJmx0O3BhdGgmZ3Q7LiopJAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgPC9vbD4KICAgICAgPHA+CiAgICAgICAgCiAgICAgICAgICBUaGUgY3VycmVudCBwYXRoLCA8Y29kZT5jaGF0L1tvYmplY3QgT2JqZWN0XTwvY29kZT4sCiAgICAgICAgCiAgICAgICAgZGlkbuKAmXQgbWF0Y2ggYW55IG9mIHRoZXNlLgogICAgICA8L3A+CiAgICAKICA8L2Rpdj4KCiAgPGRpdiBpZD0iZXhwbGFuYXRpb24iPgogICAgPHA+CiAgICAgIFlvdeKAmXJlIHNlZWluZyB0aGlzIGVycm9yIGJlY2F1c2UgeW91IGhhdmUgPGNvZGU+REVCVUcgPSBUcnVlPC9jb2RlPiBpbgogICAgICB5b3VyIERqYW5nbyBzZXR0aW5ncyBmaWxlLiBDaGFuZ2UgdGhhdCB0byA8Y29kZT5GYWxzZTwvY29kZT4sIGFuZCBEamFuZ28KICAgICAgd2lsbCBkaXNwbGF5IGEgc3RhbmRhcmQgNDA0IHBhZ2UuCiAgICA8L3A+CiAgPC9kaXY+CjwvYm9keT4KPC9odG1sPgo="
        # test_file_1 = received_data.get('new_file')
        # test_file_1 = "data:text/png;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgaHR0cC1lcXVpdj0iY29udGVudC10eXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiPgogIDx0aXRsZT5QYWdlIG5vdCBmb3VuZCBhdCAvY2hhdC9bb2JqZWN0IE9iamVjdF08L3RpdGxlPgogIDxtZXRhIG5hbWU9InJvYm90cyIgY29udGVudD0iTk9ORSxOT0FSQ0hJVkUiPgogIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICBodG1sICogeyBwYWRkaW5nOjA7IG1hcmdpbjowOyB9CiAgICBib2R5ICogeyBwYWRkaW5nOjEwcHggMjBweDsgfQogICAgYm9keSAqICogeyBwYWRkaW5nOjA7IH0KICAgIGJvZHkgeyBmb250OnNtYWxsIHNhbnMtc2VyaWY7IGJhY2tncm91bmQ6I2VlZTsgY29sb3I6IzAwMDsgfQogICAgYm9keT5kaXYgeyBib3JkZXItYm90dG9tOjFweCBzb2xpZCAjZGRkOyB9CiAgICBoMSB7IGZvbnQtd2VpZ2h0Om5vcm1hbDsgbWFyZ2luLWJvdHRvbTouNGVtOyB9CiAgICBoMSBzcGFuIHsgZm9udC1zaXplOjYwJTsgY29sb3I6IzY2NjsgZm9udC13ZWlnaHQ6bm9ybWFsOyB9CiAgICB0YWJsZSB7IGJvcmRlcjpub25lOyBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB3aWR0aDoxMDAlOyB9CiAgICB0ZCwgdGggeyB2ZXJ0aWNhbC1hbGlnbjp0b3A7IHBhZGRpbmc6MnB4IDNweDsgfQogICAgdGggeyB3aWR0aDoxMmVtOyB0ZXh0LWFsaWduOnJpZ2h0OyBjb2xvcjojNjY2OyBwYWRkaW5nLXJpZ2h0Oi41ZW07IH0KICAgICNpbmZvIHsgYmFja2dyb3VuZDojZjZmNmY2OyB9CiAgICAjaW5mbyBvbCB7IG1hcmdpbjogMC41ZW0gNGVtOyB9CiAgICAjaW5mbyBvbCBsaSB7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IH0KICAgICNzdW1tYXJ5IHsgYmFja2dyb3VuZDogI2ZmYzsgfQogICAgI2V4cGxhbmF0aW9uIHsgYmFja2dyb3VuZDojZWVlOyBib3JkZXItYm90dG9tOiAwcHggbm9uZTsgfQogICAgcHJlLmV4Y2VwdGlvbl92YWx1ZSB7IGZvbnQtZmFtaWx5OiBzYW5zLXNlcmlmOyBjb2xvcjogIzU3NTc1NzsgZm9udC1zaXplOiAxLjVlbTsgbWFyZ2luOiAxMHB4IDAgMTBweCAwOyB9CiAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8ZGl2IGlkPSJzdW1tYXJ5Ij4KICAgIDxoMT5QYWdlIG5vdCBmb3VuZCA8c3Bhbj4oNDA0KTwvc3Bhbj48L2gxPgogICAgCiAgICA8dGFibGUgY2xhc3M9Im1ldGEiPgogICAgICA8dHI+CiAgICAgICAgPHRoPlJlcXVlc3QgTWV0aG9kOjwvdGg+CiAgICAgICAgPHRkPkdFVDwvdGQ+CiAgICAgIDwvdHI+CiAgICAgIDx0cj4KICAgICAgICA8dGg+UmVxdWVzdCBVUkw6PC90aD4KICAgICAgICA8dGQ+aHR0cDovLzEyNy4wLjAuMTo4MDAwL2NoYXQvJTVCb2JqZWN0JTIwT2JqZWN0JTVEPC90ZD4KICAgICAgPC90cj4KICAgICAgCiAgICA8L3RhYmxlPgogIDwvZGl2PgogIDxkaXYgaWQ9ImluZm8iPgogICAgCiAgICAgIDxwPgogICAgICBVc2luZyB0aGUgVVJMY29uZiBkZWZpbmVkIGluIDxjb2RlPkJsb2dBcHAudXJsczwvY29kZT4sCiAgICAgIERqYW5nbyB0cmllZCB0aGVzZSBVUkwgcGF0dGVybnMsIGluIHRoaXMgb3JkZXI6CiAgICAgIDwvcD4KICAgICAgPG9sPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFkbWluLwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgW25hbWU9J3JlZ2lzdGVyJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS8KICAgICAgICAgICAgICAgIFtuYW1lPSdob21lJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J3ZpZXdfcHJvZmlsZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvdXBkYXRlLXByb2ZpbGUvCiAgICAgICAgICAgICAgICBbbmFtZT0ncHJvZmlsZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvcHJvZmlsZS9zZXR0aW5ncy8KICAgICAgICAgICAgICAgIFtuYW1lPSdzZXR0aW5ncyddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvZnJpZW5kcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdmcmllbmRzX3BhZ2UnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2ZyaWVuZHMvYmxvY2tlZAogICAgICAgICAgICAgICAgW25hbWU9J2Jsb2NrX3VzZXJfcGFnZSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvZnJpZW5kcy8mbHQ7aW50OnBrJmd0Oy8KICAgICAgICAgICAgICAgIFtuYW1lPSdmcmllbmRfZGV0YWlsJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9teS1pbnZpdGVzLwogICAgICAgICAgICAgICAgW25hbWU9J215X2ludml0ZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2FsbC1wcm9maWxlcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdhbGxfcHJvZmlsZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL3NlYXJjaC1wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J3NlYXJjaF9wcm9maWxlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9ibG9jay1wcm9maWxlLwogICAgICAgICAgICAgICAgW25hbWU9J2Jsb2NrX3Byb2ZpbGUnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL2ludml0ZS1wcm9maWxlcy8KICAgICAgICAgICAgICAgIFtuYW1lPSdpbnZpdGVfcHJvZmlsZXMnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL3NlbmQtaW52aXRlLwogICAgICAgICAgICAgICAgW25hbWU9J3NlbmRfaW52aXRlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9yZW1vdmUtZnJpZW5kLwogICAgICAgICAgICAgICAgW25hbWU9J3JlbW92ZV9mcmllbmQnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL215LWJsb2dzLwogICAgICAgICAgICAgICAgW25hbWU9J215X2Jsb2dzJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaG9tZS9hY2NlcHQtcmVxdWVzdC8KICAgICAgICAgICAgICAgIFtuYW1lPSdhY2NlcHRfcmVxdWVzdCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvcmVtb3ZlLXJlcXVlc3QvCiAgICAgICAgICAgICAgICBbbmFtZT0ncmVtb3ZlX3JlcXVlc3QnXQogICAgICAgICAgICAKICAgICAgICAgIDwvbGk+CiAgICAgICAgCiAgICAgICAgICA8bGk+CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBob21lL25vdGlmaWNhdGlvbnMvCiAgICAgICAgICAgICAgICBbbmFtZT0nbm90aWZpY2F0aW9ucyddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFjY291bnRzL2xvZ2luLwogICAgICAgICAgICAgICAgW25hbWU9J2xvZ2luJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nb3V0LwogICAgICAgICAgICAgICAgW25hbWU9J2xvZ291dCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIHBhc3N3b3JkLXJlc2V0LwogICAgICAgICAgICAgICAgW25hbWU9J3Bhc3N3b3JkX3Jlc2V0J10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcGFzc3dvcmQtcmVzZXQvZG9uZS8KICAgICAgICAgICAgICAgIFtuYW1lPSdwYXNzd29yZF9yZXNldF9kb25lJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcGFzc3dvcmQtcmVzZXQtY29uZmlybS8mbHQ7dWlkYjY0Jmd0Oy8mbHQ7dG9rZW4mZ3Q7CiAgICAgICAgICAgICAgICBbbmFtZT0ncGFzc3dvcmRfcmVzZXRfY29uZmlybSddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIHBhc3N3b3JkLXJlc2V0LWNvbXBsZXRlLwogICAgICAgICAgICAgICAgW25hbWU9J3Bhc3N3b3JkX3Jlc2V0X2NvbXBsZXRlJ10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2hhbmdlLXBhc3N3b3JkLwogICAgICAgICAgICAgICAgW25hbWU9J2NoYW5nZV9wYXNzd29yZCddCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgICAgIDxsaT4KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhvbWUvYmxvZ3MvCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNoYXQvCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFtuYW1lPSdzdGFydC1jaGF0J10KICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF5tZWRpYS8oP1AmbHQ7cGF0aCZndDsuKikkCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICA8L2xpPgogICAgICAgIAogICAgICAgICAgPGxpPgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF5zdGF0aWMvKD9QJmx0O3BhdGgmZ3Q7LiopJAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgPC9saT4KICAgICAgICAKICAgICAgPC9vbD4KICAgICAgPHA+CiAgICAgICAgCiAgICAgICAgICBUaGUgY3VycmVudCBwYXRoLCA8Y29kZT5jaGF0L1tvYmplY3QgT2JqZWN0XTwvY29kZT4sCiAgICAgICAgCiAgICAgICAgZGlkbuKAmXQgbWF0Y2ggYW55IG9mIHRoZXNlLgogICAgICA8L3A+CiAgICAKICA8L2Rpdj4KCiAgPGRpdiBpZD0iZXhwbGFuYXRpb24iPgogICAgPHA+CiAgICAgIFlvdeKAmXJlIHNlZWluZyB0aGlzIGVycm9yIGJlY2F1c2UgeW91IGhhdmUgPGNvZGU+REVCVUcgPSBUcnVlPC9jb2RlPiBpbgogICAgICB5b3VyIERqYW5nbyBzZXR0aW5ncyBmaWxlLiBDaGFuZ2UgdGhhdCB0byA8Y29kZT5GYWxzZTwvY29kZT4sIGFuZCBEamFuZ28KICAgICAgd2lsbCBkaXNwbGF5IGEgc3RhbmRhcmQgNDA0IHBhZ2UuCiAgICA8L3A+CiAgPC9kaXY+CjwvYm9keT4KPC9odG1sPgo="
        # test = base64_file(test_file_1)
        msg = received_data.get('message')
        sent_by_id = received_data.get('sent_by')
        sent_to_id = received_data.get('send_to')
        thread_id = received_data.get('thread_id')
        if not msg:
            return False
        sent_by_user = await self.get_user_objects(sent_by_id)
        sent_to_user = await self.get_user_objects(sent_to_id)
        thread_obj = await self.get_thread(thread_id)

        if not sent_by_user:
            print('Error:: sent by user is incorrect')
        if not sent_to_user:
            print('Error:: sent to user is incorrect')
        if not thread_obj:
            print('Error:: Thread id is incorrect')

        # await self.create_chat_message(thread_obj, sent_by_user, msg,test)
        await self.create_chat_message(thread_obj, sent_by_user, msg)

        other_user_chat_room = f'user_chatroom_{sent_to_id}'
        self_user = self.scope['user']
        response = {
            'message': msg,
            'sent_by': self_user.id,
            'thread_id': thread_id
        }

        await self.channel_layer.group_send(
            other_user_chat_room,
            {
                'type': 'chat_message',
                'text': json.dumps(response)
            }
        )

        await self.channel_layer.group_send(
            self.chat_room,
            {
                'type': 'chat_message',
                'text': json.dumps(response)
            }
        )

    async def websocket_disconnect(self, event):
        print('disconnect', event)

    async def chat_message(self, event):
        print('chat_message', event)
        await self.send({
            'type': 'websocket.send',
            'text': event['text']
        })

    @database_sync_to_async
    def get_user_objects(self, user_id):
        qs = User.objects.filter(id=user_id)
        if qs.exists():
            obj = qs.first()
        else:
            obj = None
        return obj

    @database_sync_to_async
    def get_thread(self, thread_id):
        qs = Thread.objects.filter(id=thread_id)
        if qs.exists():
            obj = qs.first()
        else:
            obj = None
        return obj

    @database_sync_to_async
    def create_chat_message(self, thread, user, msg):
        ChatMessage.objects.create(thread=thread, user=user, message=msg)

    # @database_sync_to_async
    # def create_chat_message(self, thread, user, msg, file_):
    #     ChatMessage.objects.create(thread=thread, user=user, message=msg, my_file=file_)

# Next step route the path to this ChatConsumer
